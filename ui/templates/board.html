<html>
  <head>

    <link href="/css/style.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/chessboard-0.3.0.min.css">
    <script src="/js/chessboard-0.3.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/json3/3.3.2/json3.min.js"></script>
    <script
       src="https://code.jquery.com/jquery-1.12.4.min.js"
       integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
       crossorigin="anonymous"></script>    
  </head>
  <body>
    
    <h1>Ghess</h1>
    
    <div id="board" style="width: 400px"></div>

    <form id="form" >
      <div>
	<input type="text" id="move" name="move" autofocus>
	<input type="submit" value="Make Move" > <button type="button" onclick="orientation()" >Flip Board</button>
      </div>
    </form>
    <div id="output" ></div>
    <div>{{ .Feedback }}</div>

    <script>
     // check out example for onDragMove() for ParseStand()
     // http://chessboardjs.com/examples#4003
     var parseStand = function(newLocation, oldLocation, source,
                               piece, position, orientation) {
	 console.log("Destination: " + newLocation);
	 //console.log("Old location: " + oldLocation);// Not origin
	 console.log("Origin: " + source);
	 console.log("--------------------");
	 // conn.send(move) // TODO
     };
     
     var pos = '{{ .Fen }}';
     var config = {
         position: pos,
	 onDragMove: parseStand,
     };
     var board = ChessBoard('board', config);
     
     function orientation(){
         board.flip();
     }
     
     // Websockets
     window.onload = function () {
	 var conn;
	 var move; // example: "e2 e4"
	 var msg = document.getElementById("move");
	 var log = document.getElementById("output");

	 function appendLog(item) {
             var doScroll = log.scrollTop === log.scrollHeight - log.clientHeight;
             log.appendChild(item);
	     
             if (doScroll) {
		 log.scrollTop = log.scrollHeight - log.clientHeight;
             }
	 }

	 document.getElementById("form").onsubmit = function () {
             if (!conn) {
		 return false;
             }
             if (!msg.value) {
		 return false;
             }              
	     // Put this into something like
	     // onDragMove() = function() { conn.send(orig+" "+dest)}
             conn.send(msg.value); // Have this send the Origin and Destination
             msg.value = "";
             return false;
	 };

	 if (window["WebSocket"]) {
	     // That is, change to proper port and route
             conn = new WebSocket("ws://localhost:8080/ws");
             conn.onclose = function (evt) {
		 var item = document.createElement("div");
		 item.innerHTML = "<b>Connection closed.</b>";
		 appendLog(item);
             };
             conn.onmessage = function (evt) {
		 var messages = evt.data.split('\n');
		 board.position(messages[0])
		 var item = document.createElement("div");
                 item.innerText = messages[1];
                 appendLog(item);
		 for (var i = 0; i < messages.length; i++) {
		     

		 }
             };
	 } else {
             var item = document.createElement("div");
             item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
             appendLog(item);
	 }
     };     
  </script>    
  </body>  
</html>
