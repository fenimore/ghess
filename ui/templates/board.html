<html>
  <head>

    <link href="/css/style.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/chessboard-0.3.0.min.css">
    <script src="/js/chessboard-0.3.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/json3/3.3.2/json3.min.js"></script>
    <script
       src="https://code.jquery.com/jquery-1.12.4.min.js"
       integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
       crossorigin="anonymous"></script>    
  </head>
  <body>
    
    <h1>Ghess</h1>
    
    <div id="board" style="width: 400px"></div>
    <div id="output" ></div>
    <form id="form" >
      <div>
	<input type="text" id="move" name="move" autofocus>
	<input type="submit" value="Make Move" >
      </div>
    </form>
    <div>{{ .Feedback }}</div>
    <button type="button" onclick="orientation()" >Flip Board</button>
    <script>
      var pos = '{{ .Fen }}';
      var config = {
        position: pos,
      };
      var board = ChessBoard('board', config);

      function orientation(){
        board.flip();
      }

     // AJAX
     (function() {
	 window.onload = function() {
	     var form = document.querySelector("form")
	     form.addEventListener("submit", function(e) {
		 e.preventDefault()
		 var x = new XMLHttpRequest()
		 x.onreadystatechange = function() {
		     if(x.readyState == 4) {
			 //console.log(x.response)
			 board.position(x.response)
		     }
		 }
		 x.open("POST", "/makemove")
		 x.send(new FormData(form))
	     })
	 }
     })()
     // Websockets
     window.onload = function () {
	 var conn;
	 var msg = document.getElementById("move");
	 var log = document.getElementById("output");
	 
	 function appendLog(item) {
             var doScroll = log.scrollTop === log.scrollHeight - log.clientHeight;
             log.appendChild(item);
             if (doScroll) {
		 log.scrollTop = log.scrollHeight - log.clientHeight;
             }
	 }

	 document.getElementById("form").onsubmit = function () {
             if (!conn) {
		 return false;
             }
             if (!msg.value) {
		 return false;
             }
             conn.send(msg.value);
             msg.value = "";
             return false;
	 };

	 if (window["WebSocket"]) {
             conn = new WebSocket("ws://localhost:8080/ws");
             conn.onclose = function (evt) {
		 var item = document.createElement("div");
		 item.innerHTML = "<b>Connection closed.</b>";
		 appendLog(item);
             };
             conn.onmessage = function (evt) {
		 var messages = evt.data.split('\n');
		 for (var i = 0; i < messages.length; i++) {
                     var item = document.createElement("div");
                     item.innerText = messages[i];
                     appendLog(item);
		 }
             };
	 } else {
             var item = document.createElement("div");
             item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
             appendLog(item);
	 }
     };     
  </script>    
  </body>  
</html>
